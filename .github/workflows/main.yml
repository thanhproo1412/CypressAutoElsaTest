name: Cypress Tests
on:
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.17.0'

      - name: Install dependencies
        run: npm install

      - name: Start application
        run: npm start > app.log 2>&1 &

      - name: Wait for application to start
        shell: pwsh
        run: |
          $timeout = 300
          $elapsed = 0
          while (-not (Test-NetConnection -ComputerName "localhost" -Port 3000).TcpTestSucceeded) {
            if ($elapsed -ge $timeout) { 
              Write-Host "Application failed to start within $timeout seconds."
              exit 1
            }
            Write-Host "Waiting for application..."
            Start-Sleep -Seconds 5
            $elapsed += 5
          }
          Write-Host "Application is running!"

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          record: true
          wait-on: "http://localhost:3000"
          wait-on-timeout: 300
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print application logs if failure
        if: failure()
        run: cat app.log

      - name: Stop application
        if: always()
        run: taskkill /F /IM node.exe || echo "Node process not found"
